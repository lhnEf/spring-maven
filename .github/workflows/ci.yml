name: Spring Boot DevSecOps
 
on:
  push:
    branches: [ main ]
 
jobs:
  build-and-analyze:
    name: Build, Sonar & Nexus
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
 
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
 
      # CORRECTION ICI : On utilise ./mvnw au lieu de mvn
      - name: Build with Maven Wrapper
        run: ./mvnw clean verify
 
      # CORRECTION ICI : ./mvnw
      - name: SonarQube Analysis
        run: ./mvnw sonar:sonar "-Dsonar.projectKey=springboot-app" "-Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}" "-Dsonar.login=${{ secrets.SONAR_TOKEN }}"
      - name: Maven Settings for Nexus
        uses: s4u/maven-settings-action@v2.8.0
        with:
          servers: |
            [{
              "id": "nexus",
              "username": "${{ secrets.NEXUS_USER }}",
              "password": "${{ secrets.NEXUS_PASSWORD }}"
            }]
 
      # CORRECTION ICI : ./mvnw
      - name: Publish to Nexus
        run: ./mvnw deploy -DskipTests
 
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: springboot-jar
          path: target/*.jar
 
  docker-push:
    name: Build & Push Docker
    runs-on: self-hosted
    needs: build-and-analyze
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
 
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: springboot-jar
          path: target
 
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
 
      - name: Build & Push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/springboot-app:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/springboot-app:latest
